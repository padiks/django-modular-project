<!-- apps/pdfview/templates/pdfview/index.html -->
{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="card shadow-lg p-4 mb-3 mx-auto" style="max-width: 900px;">
    <h4 class="mb-4 text-center">{{ title }}</h4>

    <!-- Navigation -->
    <div class="d-flex justify-content-between mb-3">
        <button id="prev" class="btn btn-primary btn-sm">Previous</button>
        <span>Page: <span id="page_num"></span> / <span id="page_count"></span></span>
        <button id="next" class="btn btn-primary btn-sm">Next</button>
    </div>

    <!-- PDF Canvas -->
    <div class="text-center">
        <canvas id="pdf_render" class="border w-100"></canvas>
    </div>
</div>

<!-- PDF.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
const url = "{{ pdf_url }}";

let pdfDoc = null,
    pageNum = 1,
    pageIsRendering = false,
    pageNumPending = null;

const scale = 1.2;
const canvas = document.querySelector("#pdf_render");
const ctx = canvas.getContext("2d");

// Render the page
const renderPage = num => {
    pageIsRendering = true;

    pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderCtx = { canvasContext: ctx, viewport };
        page.render(renderCtx).promise.then(() => {
            pageIsRendering = false;
            if (pageNumPending !== null) {
                renderPage(pageNumPending);
                pageNumPending = null;
            }
        });

        document.querySelector("#page_num").textContent = num;
    });
};

// Queue render
const queueRenderPage = num => {
    if (pageIsRendering) {
        pageNumPending = num;
    } else {
        renderPage(num);
    }
};

// Previous / Next buttons
document.querySelector("#prev").addEventListener("click", () => {
    if (pageNum <= 1) return;
    pageNum--;
    queueRenderPage(pageNum);
});

document.querySelector("#next").addEventListener("click", () => {
    if (pageNum >= pdfDoc.numPages) return;
    pageNum++;
    queueRenderPage(pageNum);
});

// Load PDF
pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
    pdfDoc = pdfDoc_;
    document.querySelector("#page_count").textContent = pdfDoc.numPages;
    renderPage(pageNum);
});
</script>
{% endblock %}
